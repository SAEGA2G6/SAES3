<!DOCTYPE html>
<html>
<head>
    <script src="javascript/phaser.min.js"></script>
</head>
<body>

    <script>
    var config = {
    type: Phaser.AUTO,
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        width: 800,
        height: 600
    },
    physics: {
        default:'arcade',
        arcade:{
            debug: true,
            gravity: {y: 0},
            debug: false
        }
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    }
    };
    var player;
    var cursors;
    var precMove; //le joueur s'arrête du côté auquel il fait face
    var initialVelocity = 130; //vitesse initiale

    var scoreText;

    var game = new Phaser.Game(config);

    function preload ()
    {        
        this.load.image('meuble1','assets/Test/meuble1.png');
        this.load.image('office','assets/Test/office.png');
        this.load.image('tileset_inside','assets/Test/tileset_inside.png');
        this.load.image('toilet','assets/Test/toilet.png');
        this.load.image('toilet2','assets/Test/toilet2.png');
        this.load.image('pc','assets/Test/pc.png');
        this.load.image('pc2','assets/Test/pc2.png');
        this.load.image('stairs','assets/Test/stair.png');
        this.load.image('couloir','assets/Test/couloir.png');
        this.load.image('bureau','assets/Test/bureau.png');
        this.load.image('toilets','assets/Test/toilets.png');
        this.load.image('meubles0','assets/Test/meubles0.png');

        
        this.load.image('wall','assets/Test/wall-tiles-autotile.png');
        this.load.tilemapTiledJSON('carte', 'assets/Test/iut_rcV2.json');
        this.load.spritesheet('player', 'img/pokemon-char-sheet.png', { frameWidth: 32, frameHeight: 48 });
    }

    function create ()
    {
        //////////CARTE//////////
        carte = this.make.tilemap({ key: 'carte' });
        tileset1 = carte.addTilesetImage("wall-tiles-autotile",'wall');
        tileset2 = carte.addTilesetImage("meuble1",'meuble1');
        tileset3 = carte.addTilesetImage("office",'office');
        tileset4 = carte.addTilesetImage("tileset_inside",'tileset_inside');
        tileset5 = carte.addTilesetImage("toilet",'toilet');
        tileset6 = carte.addTilesetImage("toilet2",'toilet2');
        tileset7 = carte.addTilesetImage("pc",'pc');
        tileset8 = carte.addTilesetImage("pc2",'pc2');
        tileset9 = carte.addTilesetImage("stair","stairs");
        tileset10 = carte.addTilesetImage("couloir","couloir");
        tileset11 = carte.addTilesetImage("bureau","bureau");
        tileset12 = carte.addTilesetImage("toilets","toilets");
        tileset13 = carte.addTilesetImage("meubles0","meubles0");



        calque1 = carte.createLayer('Calque de Tuiles 1', [tileset1,tileset2,tileset3,tileset4,tileset5,tileset6,tileset7,tileset8,tileset9,tileset10,tileset11,tileset12,tileset13],0,0);
        calque2 = carte.createLayer('Calque de Tuiles 2', [tileset1,tileset2,tileset3,tileset4,tileset5,tileset6,tileset7,tileset8,tileset9,tileset10,tileset11,tileset12,tileset13],0,0);
        calque3 = carte.createLayer('Calque de Tuiles 3', [tileset1,tileset2,tileset3,tileset4,tileset5,tileset6,tileset7,tileset8,tileset9,tileset10,tileset11,tileset12,tileset13],0,0);

        calque1.setCollisionByProperty( { estSolide: true } );
        calque2.setCollisionByProperty( {estSolide: true} );
        calque3.setCollisionByProperty( {estSolide: true} );



        /////////PLAYER/////////
        player = this.physics.add.sprite(100, 450, 'player');
        player.setScale(0.7);
        player.body.setAllowGravity(false);
        cursors = this.input.keyboard.createCursorKeys();
        spaceBar = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

        this.cameras.main.setBounds(0, 0, carte.displayWidth, carte.displayHeight);
        this.cameras.main.startFollow(player);
        this.cameras.main.zoom=2;

        this.physics.add.collider(player, [calque1,calque2,calque3]);



        this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('player', { start: 4, end: 7 }),
        frameRate: 5,
        repeat: -1
        });

        this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('player', { start: 8, end: 11 }),
        frameRate: 5,
        repeat: -1
        });

        this.anims.create({
        key: 'up',
        frames: this.anims.generateFrameNumbers('player', { start: 12, end: 15 }),
        frameRate: 5,
        repeat: -1
        });

        this.anims.create({
        key: 'down',
        frames: this.anims.generateFrameNumbers('player', { start: 0, end: 3 }),
        frameRate: 5,
        repeat: -1
        });

        this.anims.create({
        key: 'idle-left',
        frames: [ { key: 'player', frame: 4 } ],
        frameRate: 5,
        });

        this.anims.create({
        key: 'idle-right',
        frames: [ { key: 'player', frame: 8 } ],
        frameRate: 5,
        });

        this.anims.create({
        key: 'idle-up',
        frames: [ { key: 'player', frame: 12 } ],
        frameRate: 5,
        });

        this.anims.create({
        key: 'idle-down',
        frames: [ { key: 'player', frame: 0 } ],
        frameRate: 5,
        });

        scoreText = this.add.text(0, 0, 'score: 0', { fontSize: '32px', fill: '#000' });

    }

    function update ()
    {

        //deplacements

        if (cursors.left.isDown)
        {
            player.setVelocityY(0);
            player.setVelocityX(-initialVelocity);
            player.anims.play('left', true);
            precMove = 'left';
            console.log("à gauuuuche");
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityY(0);
            player.setVelocityX(initialVelocity);
            player.anims.play('right', true);
            precMove = 'right';
        }
        else if (cursors.up.isDown)
        {
            player.setVelocityX(0)
            player.setVelocityY(-initialVelocity);
            player.anims.play('up', true);
            precMove = 'up';
        }
        else if (cursors.down.isDown)
        {
            player.setVelocityX(0)
            player.setVelocityY(initialVelocity)
            player.anims.play('down', true);
            precMove = 'down';
        }
        else
        {
            if(precMove == 'left')
                player.anims.play('idle-left', true);
            else if(precMove == 'right')
                player.anims.play('idle-right', true);
            else if(precMove == 'up')
                player.anims.play('idle-up', true);
            else if(precMove == 'down')
                player.anims.play('idle-down', true);
                
            player.setVelocityX(0);
            player.setVelocityY(0);
        }


        //actions



        if(spaceBar.isDown)
            scoreText.setText('ça marche');
    }
    </script>

</body>
</html>